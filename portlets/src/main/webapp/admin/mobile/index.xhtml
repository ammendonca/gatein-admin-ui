<ui:composition template="/template.xhtml"
				xmlns="http://www.w3.org/1999/xhtml"
				xmlns:h="http://java.sun.com/jsf/html"
				xmlns:f="http://java.sun.com/jsf/core"
				xmlns:ui="http://java.sun.com/jsf/facelets"
				xmlns:rich="http://richfaces.org/rich"
				xmlns:a4j="http://richfaces.org/a4j"
				xmlns:b="http://richfaces.org/sandbox/bootstrap">

<ui:define name="content">
	<h:form id="sum_form" styleClass="form-horizontal">
		<h1 class="hOne"><a4j:outputPanel id="siteName"><h:outputText styleClass="gray" value="#{mr.siteName}" /></a4j:outputPanel> Mobile Redirects</h1>
		<a class="btn btn-small pull-right" id="add-redirect">Add Redirect</a>
			<h:panelGroup rendered="#{mr.redirects.size() == 0}">
				<h2 class="initial">You have not set up any redirects.</h2>
				<p class="initial">Redirect to an alternative site based on the device, browser or user preferences.</p>
				<h:graphicImage class="initial" library="img" name="mobile-redirects.png" alt="Illustration: Arrow pointing from a laptop to a tablet and a smartphone" />
			</h:panelGroup>

			<h:panelGroup rendered="#{mr.redirects.size() > 0}">
				<table id="redirect-table" class="table table-striped">
					<thead id="redirect-summary-header" class="redirect-summary">
						<tr>
							<th>Status</th>
							<th>Redirect name</th>
							<th>Configurations</th>
							<th class="actions hidden-element">Actions</th>
						</tr>
					</thead>
					<tbody>
					<ui:repeat value="#{mr.redirects}" var="r" varStatus="status">
						<!-- Redirect Summary Row -->
						<tr id="rdr_sum_${status.index}" class="redirect-summary">
							<td>
								<div class="onoffswitch">
									<h:selectBooleanCheckbox id="rdr_toggle_${status.index}" styleClass="onoffswitch-checkbox" value="#{r.isEnabled()}" />
									<h:outputLabel for="rdr_toggle_${status.index}" styleClass="onoffswitch-label">
										<span class="onoffswitch-inner">
											<span class="onoffswitch-active">ON</span>
											<span class="onoffswitch-inactive">OFF</span>
										</span>
										<span class="onoffswitch-switch"></span>
									</h:outputLabel>
								</div>
							</td>
							<td>#{r.name}</td>
							<td>Redirect to #{r.redirectSite} <span class="second-info">#{r.conditions.size()} conditions and #{r.mappings.mappings.size()} mappings</span></td>
							<td class="actions">
								<h:commandLink styleClass="configure-redirect redirect-summary" value="Configure">
									<f:ajax event="action" render=":edit_form" listener="#{rdrEdit.load(mr.siteName, r.name)}" />
								</h:commandLink>
								<button class="tooltipTrigger delete-redirect" title="Delete Redirect"><i class="icon-trash">Delete Redirect</i></button>
							</td>
						</tr>
					</ui:repeat>
					</tbody>
				</table>
			</h:panelGroup>
		</h:form>

		<!-- Edit Redirect Table -->
		<h:form id="edit_form" styleClass="form-horizontal">
		<h:panelGroup id="edit_group" styleClass="edit-group" style="display: none;">
			<table id="edit_redirect-table" class="table table-striped">
				<tbody>
					<tr style="display: none;"><td></td></tr>
					<tr id="redirect_cfg" class="form-mobile-redirect">
						<td colspan="4" style="padding-top: 10px;">
								<fieldset class="header-mobile-redirect">
									<legend class="hidden-element">
										<span>General Settings</span>
									</legend>
									<div class="onoffswitch">
										<h:selectBooleanCheckbox name="onoffswitch" styleClass="onoffswitch-checkbox" id="redirect3" value="#{rdrEdit.enabled}"/>
										<h:outputLabel for="redirect3" styleClass="onoffswitch-label">
											<span class="onoffswitch-inner">
												<span class="onoffswitch-active">ON</span>
												<span class="onoffswitch-inactive">OFF</span>
											</span>
											<span class="onoffswitch-switch"></span>
										</h:outputLabel>
									</div>
									<div class="control-group">
										<h:outputLabel for="name" styleClass="control-label">Redirect Name</h:outputLabel>
										<div class="controls">
											<b:input scale="medium" id="name" placeholder="Redirect Name" value="#{rdrEdit.name}"/>
										</div>
									</div>
									<div class="control-group">
										<h:outputLabel for="redirect" styleClass="control-label">Redirect to</h:outputLabel>
										<div class="controls">
											<h:selectOneMenu id="redirect" value="#{rdrEdit.redirectSite}" style="height: 30px; line-height: 30px;">
												<f:selectItems value="#{mr.sites}" var="site" itemLabel="#{site.name}" itemValue="#{site.id}"/>
											</h:selectOneMenu>
										</div>
									</div><!-- End .control-group -->
								</fieldset>
								<fieldset>
									<legend>
										<span class="toggle">Conditions</span>
									</legend>
									<div>
										<div class="control-group">
											<div class="controls">
												<a class="btn btn-small inside-table add-condition">Add Condition</a>
												<table class="table table-striped button-small">
													<thead>
														<tr>
															<th>Condition Name</th>
															<th>Settings</th>
															<th class="hidden-element actions">Actions</th>
														</tr>
													</thead>
													<tbody class="sortable">
														<ui:repeat value="#{rdrEdit.conditions}" var="rc" varStatus="rc_st">
														<tr class="ui-state-default">
															<td>#{rc.name}</td>
															<td>Contains 
																<ui:repeat value="#{rc.userAgentConditions.contains}" var="rcUACcont" varStatus="cnt_st">
																	<h:panelGroup rendered="#{not cnt_st.first}">
																	 OR 
																	</h:panelGroup>
																	'#{rcUACcont}'
																</ui:repeat>
															</td>
															<td>Does not contain
																<ui:repeat value="#{rc.userAgentConditions.doesNotContain}" var="rcUACnotcont" varStatus="dnc_st">
																	<h:panelGroup rendered="#{not dnc_st.first}">
																	 OR 
																	</h:panelGroup>
																	'#{rcUACnotcont}'
																</ui:repeat>
															</td>
															<td class="actions">
																<a4j:commandLink styleClass="add-condition" render=":condition_form" execute="@this" oncomplete="$('#modal-condition').modal()" value="Edit"><a4j:param value="#{rc_st.index}" assignTo="#{rdrEdit.currentConditionIndex}" /><f:setPropertyActionListener target="#{rdrEdit.editedCondition}" value="#{rc}" /></a4j:commandLink>
																<button class="tooltipTrigger" title="Delete Condition"><i class="icon-trash">Delete Condition</i></button>
															</td>
														</tr>
														</ui:repeat>
													</tbody>
												</table>							
											</div>
										</div><!-- End .control-group -->
									</div>
								</fieldset>
								<fieldset>
									<legend>
										<span class="toggle">Node Mappings</span>
									</legend>
									<div>
										<div class="control-group">
											<label for="matching" class="control-label">Matching</label>
											<div class="controls">
												<label class="checkbox">
													<h:selectBooleanCheckbox name="matching" id="matching" value="#{rdrEdit.mappings.isUseNodeNameMatching()}"/>Use node name matching
													<i class="icon-info-sign icon-gray tooltipRightTrigger" title="Origin Node Name matches Redirect Node Name">Origin Node Name matches Redirect Node Name</i>
												</label>
											</div>
										</div><!-- End .control-group -->
										<div class="control-group">
											<label class="control-label">Mappings</label>
											<div class="controls">
												<a id="btn-add-mapping" class="btn btn-small inside-table">Add Mapping</a>
												<table class="table table-striped action-button" id="mappings">
													<thead>
														<tr>
															<th>Origin Node Name</th>
															<th>Redirect Node Name</th>
															<th class="hidden-element actions">Actions</th>
														</tr>
													</thead>
													<tbody id="mappings-tbody">
														<tr>
															<td>
																<b:input scale="medium" placeholder="e.g. homepage" >
																	<b:autocomplete suggestions="#{mr.nodes}" />
																	<f:facet name="append">
																		<b:commandButton styleClass="tooltipTrigger select-node" title="View Node List"><i class="icon-list" ></i></b:commandButton>
																	</f:facet>
																</b:input>
															</td>
															<td>
																<b:input scale="medium" placeholder="e.g. home_page" >
																	<b:autocomplete suggestions="#{mr.nodes}" />
																	<f:facet name="append">
																		<b:commandButton styleClass="tooltipTrigger select-node" title="View Node List"><i class="icon-list" ></i></b:commandButton>
																	</f:facet>
																</b:input>
															</td>
															<td class="actions">
																<a href="#" class="edit-node-mapping tooltipTrigger" title="Delete Node Mapping"><i class="icon-trash">Delete Node Mapping</i></a>
															</td>
														</tr>
														<ui:repeat value="#{rdrEdit.mappings.mappings}" var="m">
														<tr>
															<td>#{m.originNode}</td>
															<td>#{m.redirectNode}</td>
															<td class="actions">
																<a href="#" class="link edit-node-mapping">Edit</a>
																<a href="#" class="edit-node-mapping tooltipTrigger" title="Delete Node Mapping"><i class="icon-trash">Delete Node Mapping</i></a>
															</td>
														</tr>
														<!-- Just so that we keep the odd/even colors -->
														<tr style="display: none;"><td></td></tr>
														<tr class="hidden-element">
															<td>
																<b:input scale="medium" placeholder="e.g. homepage" value="#{m.originNode}">
																	<b:autocomplete suggestions="#{mr.nodes}" />
																	<f:facet name="append">
																		<b:commandButton styleClass="tooltipTrigger select-node" title="View Node List"><i class="icon-list" ></i></b:commandButton>
																	</f:facet>
																</b:input>
															</td>
															<td>
																<b:input scale="medium" placeholder="e.g. home_page" value="#{m.redirectNode}">
																	<b:autocomplete suggestions="#{mr.nodes}" />
																	<f:facet name="append">
																		<b:commandButton styleClass="tooltipTrigger select-node" title="View Node List"><i class="icon-list" ></i></b:commandButton>
																	</f:facet>
																</b:input>
															</td>
															<td class="actions">
																<a href="#" class="edit-node-mapping tooltipTrigger" title="Delete Node Mapping"><i class="icon-trash">Delete Node Mapping</i></a>
															</td>
														</tr>
														</ui:repeat>
													</tbody>
												</table>							
											</div>
										</div><!-- End .control-group -->
										<div class="control-group">
											<label class="control-label" for="nodes">Unresolved nodes</label>
											<div class="controls">
												<h:selectOneMenu id="nodes" style="height: 30px; line-height: 30px;" value="#{rdrEdit.mappings.unresolvedNode}">
													<f:selectItem itemValue="REDIRECT" itemLabel="Redirect" />
													<f:selectItem itemValue="NO_REDIRECT" itemLabel="No Redirect" />
													<f:selectItem itemValue="ROOT" itemLabel="Redirect to root" />
													<f:selectItem itemValue="COMMON_ANCESTOR_NAME_MATCH" itemLabel="Ancestor Name Match" />
												</h:selectOneMenu>
											</div>
										</div><!-- End .control-group -->
									</div>
								</fieldset>
								<div class="form-actions" style="background: none;">
									<button id="edit_cancel" class="btn" type="submit">Cancel</button>
									<button id="edit_save-changes" class="btn btn-primary disabled" type="submit">Save changes</button>
								</div><!-- End .form-actions -->
						</td>
					</tr>
				</tbody>
			</table>
		</h:panelGroup>
		</h:form><!-- End .form-horizontal -->


		<!-- Template for new node mappings -->
		<table id="tt-nm" style="display: none;">
			<tr>
				<td>
					<b:input scale="medium" placeholder="e.g. homepage" >
						<b:autocomplete suggestions="#{mr.nodes}" />
						<f:facet name="append">
							<b:commandButton icon="list" styleClass="tooltipTrigger select-node" title="View Node List" />
						</f:facet>
					</b:input>
				</td>
				<td>
					<!-- TODO: Replace by JSF -->
					<b:input scale="medium" placeholder="e.g. home_page" >
						<b:autocomplete suggestions="#{mr.nodes}" />
						<f:facet name="append">
							<b:commandButton icon="list" styleClass="tooltipTrigger select-node" title="View Node List" />
						</f:facet>
					</b:input>
				</td>
				<td class="actions">
					<a href="#" class="edit-node-mapping tooltipTrigger" title="Delete Node Mapping"><i class="icon-trash">Delete Node Mapping</i></a>
				</td>
			</tr>
		</table>

		<script type="text/javascript">
			$(document).ready(function(){
				var nodeInput = null;
			});
		</script>

		<ui:include src="/admin/mobile/modals/modals.xhtml" />
		<ui:include src="/admin/mobile/modals/modal-condition.xhtml" />
		<ui:include src="/admin/mobile/modals/modal-select_node.xhtml" />
		<ui:include src="/admin/mobile/modals/modal-delete_site.xhtml" />
		<ui:include src="/admin/mobile/modals/modal-import_site.xhtml" />

	</ui:define>
</ui:composition>